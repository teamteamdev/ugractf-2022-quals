SECRET = 174807

class Stream:
    value = 1

    @classmethod
    def bit(cls) -> int:
        b = 0
        i = 0

        while SECRET > 2 ** i:
            b ^= (SECRET >> i) & (cls.value >> i) & 1
            i += 1
        
        cls.value = ((b << i) | cls.value) >> 1

        return b

    @classmethod
    def byte(cls) -> int:
        for _ in range(8):
            cls.bit()
        return cls.value & 255


def encrypt(plaintext: bytes) -> bytes:
    return bytes(
        byte ^ Stream.byte()
        for byte in plaintext
    )


PREFIX = b"ugra_"

with open("flag.enc", "rb") as flag_file:
    encrypted = flag_file.read()

for offset in range(131071):
    value = Stream.value

    if encrypt(PREFIX) == encrypted[:len(PREFIX)]:
        Stream.value = value
        print(offset, encrypt(encrypted))

    Stream.value = value
    Stream.bit()

